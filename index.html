<!DOCTYPE HTML>
<html>
<head>
    <title>ComPIEler</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="compiler.css" />
</head>
<body onload="init();">
    <h1>Aidan's Com<strong>pie</strong>ler Project</h1>
    <p>
        pie because it's like the food
    </p>

    <!--
    <pre>
G ::== E
E ::== D O E | D
D ::== 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 0
O ::== + | -
    </pre> 
    <div>
        <img style="float:right;" src="images/CompilerPhases.png" alt="Compiler Phases diagram" />
    </div>   --> 
    <div>
        <textarea id="taSourceCode" cols="64" rows="10">{ int a }$ {int b}
$ {int c}   $
{int d}$</textarea>
        <br>
        Verbose Mode is <input type="button" id="btnVerbose" value="OFF" onclick="btnVerbose_click();"/>
        <br>
        <strong>
            <input type="button" id="btnCompile" value="Compile" onclick="btnCompile_click();"/>
        </strong>
        <br>
        <textarea id="taOutput" cols="64" rows="25" readonly></textarea>
    </div>
    <!-- Footer -->
    <p>
        <!--
        <a href="http://validator.w3.org/check?uri=referer">
            <img src="images/w3cvalidhtml5.jpg" alt="Valid HTML5" width="88" height="31" />
        </a> -->
    </p>
    <!-- Client-side code down here, per the YSlow advice. 
    // (http://developer.yahoo.com/performance/rules.html#js_bottom) -->
    <script type="text/javascript" src="scripts/token.js"></script>	
    <script type="text/javascript" src="scripts/error.js"></script>
    <script type="text/javascript" src="scripts/warning.js"></script>

    <script type="text/javascript" src="scripts/utils.js"></script>	
    <!--<script type="text/javascript" src="scripts/lexer.js"></script>-->
    <script type="text/javascript" src="scripts/lexer2.js"></script>	
    <script type="text/javascript">
    // Global variables
    const LINE = 0;
    const CHAR = 1;
    var tokenStream = [];
    var tokenCount = 0;
    //var errorIndex = 0;
    var warningCount = 0;
    var errorCount = 0;
    var currentToken = "";
    var EOF = "$";
    var debug = false;

    
    function init() {
        // Clear the message box.
        document.getElementById("taOutput").value = `\n\n\n\n\n\n\n
                               )  
                              (  \`  
                          )   ) ( 
                          __..---..__
                      ,-='  /  |  \\  \`=-.
                     :--..___________..--;
                      \\.,_____________,./`;
        //Pie credit: https://ascii.co.uk/art/pie

        // Set the initial values for our globals.
        tokens = "";
        tokenCount = 0;
        currentToken = ' ';
        errorCount = 0;        
    }

    
    function btnCompile_click() {        
        // This is executed as a result of the usr pressing the 
        // "compile" button between the two text areas, above.  
        // Note the <input> element's event handler: onclick="btnCompile_click();
        
        init();
        document.getElementById("taOutput").value = "";
        putMessage("Compilation Started!");
        putMessage("");
        
        //Separate the user generated source code into programs
        programs = getPrograms();
        //Add more spacing to each program so indexing reveals correct numbers to the user
        programs = addSpacing(programs);

        //Run process one by one
        for (var i = 0; i < programs.length; i++) {
            putMessage("~~~~~ Program #"+ (i+1) +" ~~~~~");

            //Lex
            var isLexSuccessful = lex(programs[i]);
            putMessage("Lex complete with " + warningCount +" warning(s) and "+ errorCount+" error(s)");
            putMessage("");

            //Reset errors
            warningCount = 0;
            errorCount = 0;
            tokenCount = 0;

            //Parse... later
        }
    }


    function btnVerbose_click() {        
        // Toggleable button: Verbose mode on or off
        // On, turns on debug feautres, printing a more in-depth compiler output
        if (document.getElementById("btnVerbose").value === "OFF") {
            document.getElementById("btnVerbose").value = "ON";
            debug = true;
        }
        else {
            document.getElementById("btnVerbose").value = "OFF";
            debug = false;
        }
    }
    

    function putMessage(msg) {
        document.getElementById("taOutput").value += msg + "\n";
    }
    function putDebug(msg) {
        if (debug) {
            putMessage("    "+msg);
        }
    }
    

    function getPrograms() {
        //Grab the "raw" source code. (force a separator to the end)
        var sourceString = document.getElementById("taSourceCode").value;
        
        //Split source string into separate programs
        var programs = sourceString.split("$");  
        for (var i = 0; i < programs.length; i++) {
            //Add $ where they rightfully belong (all but the last "separated program")
            if (i != programs.length-1) {
                programs[i] = programs[i] + "$"
            }
            putDebug("<<"+ programs[i]+">>");
        }  

        //Get rid of a possible empty final program
        var finalProgram = programs[programs.length-1];
        if (finalProgram.replaceAll("\n","").replaceAll(" ", "") === "") {
            removeFinalProgram = programs.pop();
        }
        return programs;
    }


    function addSpacing(programs) {
        for (var i = 1; i < programs.length; i++) {
            //get previous program spacing
            var previousProgram = programs[i-1];
            var spacingString = "";

            //count the length of previous program
            for (var char in previousProgram) {
                if (previousProgram[char] === "\n"){
                    spacingString += "\n";
                }
                else {
                    spacingString += " ";
                }
            }

            //add sapces to the beginning of current program
            programs[i] = spacingString + programs[i];
        }
        return programs;
    }
    </script>
</body>
</html>
